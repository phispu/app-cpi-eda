---
title: "clean-data"
author: "Stephen Uong"
date: "2024-08-27"
output: html_document
---
# Load libraries
```{r}
library(rio)
library(tidyverse)
library(lubridate)
library(tigris)
library(gganimate)
library(scales)
library(ggplot2)
```

# Import data
```{r}
# Import fred data:
fred_prelim <- import("../data/fred_data_pull.csv") %>% 
  as_tibble()

# Import/prep spatial data:
states_sf <- st_read("../data/cb_2018_us_state_20m/cb_2018_us_state_20m.shp") %>% 
  # Figure out code to add inset for these states
  dplyr::filter(!NAME %in% c("Alaska", "Hawaii","Puerto Rico")) 
cbsa_sf_prelim <- core_based_statistical_areas()
cbsa_sf <- cbsa_sf_prelim %>% 
  dplyr::filter(str_detect(NAMELSAD, "(San Francisco)|(New York)")) %>% 
  st_centroid() 
cbsa_coord <- cbsa_sf %>% st_coordinates() %>% as_tibble() %>% 
  dplyr::rename(lon = X, lat = Y)
cbsa_name <- cbsa_sf %>% dplyr::pull(NAMELSAD) %>% 
  as_tibble_col(column_name = "msa") %>% 
  dplyr::mutate(msa = dplyr::case_when(
    msa %>% str_detect("New York") ~ "NY",
    msa %>% str_detect("San Francisco") ~ "SF"
  ))
cbsa_df <- bind_cols(cbsa_name, cbsa_coord) %>% 
  dplyr::mutate(msa)

```

# Clean data
```{r}
fred_vase <- fred_prelim %>% 
  dplyr::select(-V1) %>% 
  dplyr::mutate(year = year(date)) %>% 
  dplyr::group_by(msa, metric, year) %>% 
  dplyr::summarize(value = median(value)) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(cbsa_df, by = "msa")

fred_ratio = fred_base |>
  left_join(fred_base, by = c('msa', 'year'), relationship = 'many-to-many') |>
  filter(metric.x != metric.y) |>
  mutate(metric = paste(metric.x, metric.y, sep = '_'),
         value = value.x / value.y) |>
  select(msa, metric, year, value) 

fred_stack = fred_base |>
  mutate(ratio = 0) |>
  rbind(fred_ratio |>
          mutate(ratio = 1))
  
```

# Filter
```{r}
fred_filter <- fred
## Example:
# fred_filter <- fred %>% dplyr::filter(msa == "SF")
```


# Graphs
## By Time
```{r}


library(scales)
library(ggplot2)

options(scipen = 999)

pick_msa = 'SF' 
pick_metric_1 = 'CPI'
pick_metric_2 = 'Income'
pick_ratio = paste(pick_metric_1, pick_metric_2, sep = '_')

fred_filter_msa = fred_stack |>
  dplyr::filter(msa == {pick_msa}) 

fred_filter_msa_base = fred_filter_msa |>
  filter(metric %in% c(pick_metric_1, pick_metric_2)) |>
  mutate(metric = case_when(metric == pick_metric_1 ~ 'metric_1',
                            metric == pick_metric_2 ~ 'metric_2')) |>
  pivot_wider(id_cols = year, names_from = metric, values_from = value)

# Function factory for secondary axis transforms
func_secondary_axis <- function(primary, secondary) {

  from <- range(secondary, na.rm = TRUE)
  to   <- range(primary, na.rm = TRUE)
  # Forward transform for the data
  forward <- function(x) {
    rescale(x, from = from, to = to)
  }
  # Reverse transform for the secondary axis
  reverse <- function(x) {
    rescale(x, from = to, to = from)
  }
  list(fwd = forward, rev = reverse)
}

sec = with(fred_filter_msa_base, func_secondary_axis(metric_1, metric_2))

p1 = fred_filter_msa_base |>
  ggplot(aes(x = year)) +
  geom_line(aes(y = metric_1), color = 'blue') +
  geom_line(aes(y = sec$fwd(metric_2)), color = 'red')+
  scale_y_continuous(sec.axis = sec_axis(~sec$rev(.), name = pick_metric_2)) +
  labs(x = 'year', y = pick_metric_1)

p2 = fred_filter_msa |>
  filter(metric == pick_ratio) |>
  ggplot(aes(x = year, y = value, color = metric)) + 
  geom_line() +
  theme_bw() + 
  labs(title = "Change Over Time",
       x = "Year", y = "Value", color = "Metric") + 
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5, face = "bold"))

p1 + p2 + plot_layout(ncol = 1, nrow = 2)

```



```

## By Area
```{r}
# To do:
  # add projection
  # add north arrow/scalebar

# Require: choose variable
# Conditional: choose year, but can animate over year

# Data prep
fred_map_static <- fred_filter %>% 
  dplyr::filter(year == 2000, metric == "CPI")
fred_map_anim <- fred_filter %>% 
  dplyr::filter(metric == "CPI")

# static map
ggplot() +
  geom_sf(data = states_sf, fill = "white") +
  geom_point(data = fred_map_static,
             aes(x = lon, y = lat, size = value),
             color = "skyblue", alpha = 0.2) +
  geom_text(data = fred_map_static, aes(x = lon, y = lat, label = msa),
            nudge_y = 1.5, nudge_x = -1) +
  theme_void() +
  labs(size = "Value") +
  theme(legend.position = "bottom")
# animated map
ggplot() +
  geom_sf(data = states_sf, fill = "white") +
  geom_point(data = fred_map_anim,
             aes(x = lon, y = lat, size = value),
             color = "skyblue", alpha = 0.2) +
  geom_text(data = fred_map_anim, aes(x = lon, y = lat, label = msa),
            nudge_y = 1.5, nudge_x = -1) +
  theme_void() +
  labs(title = "Year: {frame_time}", size = "Value") +
  theme(legend.position = "bottom") +
  transition_time(year)

```

